# 모니터링 (Monitoring)

## 개요
- bpytop 명령을 실행하게 되면 화면으로 리소스의 상태 및 문제가 될 가능성이 있는 정보를 한눈에 파악할 수 있다.
- 그러나, bpytop은 현재 노드에 대한 정보만 보여줄 뿐 다수의 노드로 구성된 클러스터 정보를 모두 표현하기 어렵다.
- 모든 모니터링 도구는 수집 → 통합 → 시각화 구조로 되어 있다.

## 모니터링 도구 선택
> 왜 하나의 도구로 처리하지 않고 프로메테우스와 그라파나 혼합 구조를 사용할까?

### 비용 
- 모니터링 대상마다 라이센스 관련 비용 발생
- 클라우드 같은 과금제 서비스를 이용하면 네트워크와 저장 공간에 따른 추가 비용 발생

### 보안
- 서비스형 모니터링 도구(통합 도구)들은 대부분 외부에 데이터를 저장해 모니터링한다.
- 보안에 민감해서 내부에서 모든 데이터를 처리하려는 경우 사용이 어렵다.

## 데이터 수집과 통합 도구
|구분|프로메테우스|데이터독|뉴 렐릭|인플럭스DB|
|--|--|--|--|--|
|가격|무료|유료|유료|유/무료|
|형태|설치형|서비스형|서비스형|서비스형/설치형|
|참고 자료|매우 많음|많음|많음|많음|
|기능 확장성|매우 좋음|좋음|좋음|좋음|

## 데이터 시각화 도구 
|구분|그라파나|키바나|크로노그래프|
|--|--|--|--|
|가격|유/무료|유/무료|유/무료|
|형태|서비스형/설치형|서비스형/설치형|서비스형/설치형|
|시각화 대상|다양한 대상 시각화 가능|엘라스틱서치|인플럭스DB|
|정보량|많음|많음|적음|
|기능 확장성|좋음|좋음|적음|

## 모니터링 데이터 수집

### cAdvisor
- 쿠버네티스 노드는 kubelet을 통해 파드를 관리하며, 파드의 CPU나 메모리 같은 메트릭 정보를 수집하기 위해 kubelet에 내장된 cAdvisor를 사용한다.
- 구글이 만든 컨테이너 메트릭 수집 도구로써, 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후 가공해 kubelet에 전달한다.
- cAdvisor로 수집되고 kubelet으로 공개되는 데이터가 있어도 외부에서 이를 모아 표현해주지 못한다면 의미가 없다.

### 리소스 메트릭 파이프라인
- HPA는 시스템의 부하 여부에 따라 pod를 scale-out 시키는 모듈이고, HPA를 위해서는 시스템의 부하 여부를 파악해야 한다.
- 시스템의 부하 여부는 기본적으로 시스템 메트릭(CPU나 메모리 사용량)을 모니터링한다.
- 이러한 시스템 메트릭이 위에서 소개한 cAdvisor이다. (메트릭을 가져오는 역할은 Metrics-Server)
<p align="center"><img src="../images/resource_metric_pipeline.png" width="700"></p>

1. cAdvisor에서 지표 수집 → kubelet으로 전송
2. Metrics-Server 에서 해당 metric 들을 사용하기 위한 커스텀 api를 k8s Aggregator를 통해 API Server에 등록
3. 등록된 metrics api를 통해 수집된 system metric이 HPA로 전송
4. 설정 값에 따라 HPA에서 controller에 명령을 내린다.
5. 명령을 받은 controller에서 pod를 scale-out 시킨다.
6. 이것은 HPA에 관한 설명이고, 쿠버네티스 대시보드로의 시각화 또한 비슷한 과정을 거친다.

### 완전한 모니터링 파이프라인
- 메트릭 서버는 집계 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고 현재 시점의 데이터만 출력된다.
- 메트릭 데이터를 저장 공간에 따로 저장하는 완전 모니터링 파이프라인이 필요하다. (프로메테우스가 여기에 해당)
<p align="center"><img src="../images/full_monitoring_pipeline.png" width="700"></p>

1. system metric처럼 service metric은 기본 제공 metric이 아니므로 metric을 수집하는 에이전트를 두어야 한다.
2. 수집한 metric을 모니터링 시스템으로 전송한다.
3. 전송한 metric은 대시보드로 확인 혹은 HPA로 보내 커스텀 부하 측정을 가능하게 한다.























