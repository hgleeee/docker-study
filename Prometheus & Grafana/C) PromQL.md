# PromQL
> PromQL의 표현식과 이를 활용해 필요한 데이터를 추출하는 방법

## 메트릭 데이터의 구조
### 개요
- up{job="prometheus"}을 쿼리 입력기에 입력한다. (up은 수집 대상이 작동하고 있는지 알려준다.)
- 결과로 나온 메트릭 데이터를 보면 up이라는 메트릭 이름을 가지는 대상을 검색하고, 그중에 job="prometheus"라는 레이블 이름을 검색 조건에 추가한다.
- 이를 __필터링__ 이라고 하고 메트릭 데이터가 존재하고 추출에 성공하면 1이라는 값으로(Value 열) 표현한다.

### 메트릭 값의 종류
#### 카운터(Counter)
- 누적된 값을 표현하는데 사용하는 메트릭 타입
- 카운터에 누적된 값으로 구간별로 변화율을 파악해 해당 값이 어떤 추세로 증가하는지 파악 가능하다.
- 값이 누적되므로 특정 순간의 데이터를 표현하는데는 적합하지 않으며, 주로 변화율을 파악할 때 쓰인다.
#### 게이지(Gauge)
- 특정 시점의 값을 표현하는데 사용하는 메트릭 타입
- CPU 온도나 메모리 사용량 등은 누적값이 필요하지 않고 현재 값만 중요하므로 게이지 타입을 사용한다.
#### 히스토그램(Histogram)
- 사전에 미리 정의한 구간 안에 있는 메트릭 값의 빈도 측정
- 이때 익스포터를 구현하는 단계에서 정의한 구간을 버킷이라 한다.
- 히스토그램을 사용해 클라이언트가 서버로 HTTP 요청을 한 경우 응답 시간과 맞는 버킷에 값을 추가하고 이벤트 횟수를 저장해 표시할 수 있다.
#### 서머리(Summary)
- 히스토그램과 비슷하고, 클라이언트 요청에 따른 응답 시간을 관측하고 저장할 때 사용할 수 있다.
- 히스토그램과 달리 구간이 지정되는 것이 아니라 프로메테우스 자체적으로 0~1 사이로 구간을 미리 정한다.

#### 팁
- 일반적으로 메트릭 이름이 어떤 단어로 끝나는가에 따라 메트릭 값의 타입을 추정할 수 있다.
- total로 끝나면 누적값이므로 카운터 타입이고, bytes 또는 created로 끝나면 해당 시점의 용량 또는 생성됨을 의미하므로 게이지 타입이다.


### 메트릭 레이블
- 모든 메트릭 데이터는 하나 이상의 레이블을 가진다.
- 프로메테우스의 레이블은 일반적인 주석이 아닌, 메트릭 데이터의 다양한 내용을 표현하는 유일한 방법으로 key-value 형태를 활용한다.
- 레이블 검색 예시 : (up{job="kubernetes-nodes", up{instance="m-k8s"))

### 메트릭 레이블 매처
- 메트릭 레이블에 조건을 줘서 검색하는 방법을 레이블 매처라고 한다.
- 레이블이 존재하면 그에 해당하는 메트릭 데이터를 추출하며, 레이블 매처에는 앞에서 사용한 '='를 포함해 4가지 조건 기호가 있다.

#### 조건 기호
- = : 조건에 넣은 값과 레이블 값이 같은 메트릭을 보여준다. {instance="m-k8s"}는 instance 레이블 값이 m-k8s인 메트릭을 찾아 출력한다.
- != : 조건에 넣은 값과 레이블 값이 다른 메트릭을 보여준다. {instance!="m-k8s"}는 instance 레이블 값이 m-k8s가 아닌 메트릭을 찾아 출력한다.
- =~ : 조건에 넣은 정규 표현식에 해당하는 메트릭을 보여준다. {instance=~"w.+"}는 instance 레이블 값이 w로 시작하는 메트릭을 찾아 출력한다.
- !~ : 조건에 넣은 정규 표현식에 해당하지 않는 메트릭을 보여준다. {instance!~"w.+"}는 instance 레이블 값이 w로 시작하지 않는 메트릭을 찾아 출력한다.

### 실습 (레이블 매처로 필터링)
#### 1) 워커 노드 가용 메모리 검색
- 일반적으로 마스터 노드에는 중요 파드들이 이미 스케줄링되어 있으므로, 쿠버네티스 클러스터의 안정적 운영을 위해 일반 애플리케이션 파드는 워커 노드에 스케줄링한다.
- 워커 노드의 리소스를 관리하지 않는다면 가용 리소스가 없어서 파드가 배포되지 않을 수 있으므로 모니터링이 필요하다.
- __node_memory_MemAvailable_bytes{kubernetes_node!="m-k8s"}__ 로 검색한다.

#### 2) coredns로 시작하는 디플로이먼트에서 다시 시작한 횟수 검색
- 단순히 레이블만 이용하는 검색 조건은 충분하지 않다.
- 예를 들어 deployment에 속한 파드 이름은 해시 문자가 추가되므로 정확한 이름은 예측이 불가능하다.
- 이러한 경우, 변하지 않는 이름은 지정하고 변화하는 해시 문자는 *(애스터리스크)로 표시하면 된다.
- __kube_pod_container_status_restarts_total{pod=~"coredns.*"}__ 로 검색한다.

#### 3) 필요한 메트릭 데이터만 검색
- 검색 결과에 따라 필요 없는 정보가 너무 많은 경우가 있다.
- instance 레이블에 호스트 이름이 아닌 IP 주소가 적힌 것은 제거해보자.
- __up{instance!~"^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}:.+$"}__ 로 검색한다. (정규 표현식은 IP 주소를 나타낸다.)

## PromQL 연산자
### 비교 연산자
- 레이블 매처와 유사한 형태이나 비교 대상이 숫자이므로 크기를 구분하는 조건이 있다.
- ==, !=, >, <, >=, <= 이 있다.

### 논리 연산자
- 수집된 메트릭에서 보고싶은 범위를 지정하는 and(교집합), or(합집합), unless(차집합) 연산자가 있다.
- and 연산자는 양쪽 표현식의 레이블 값이 서로 일치하는 경우 왼쪽 값 반환
- or 연산자는 왼쪽 표현식으로 출력되는 값이 없는 경우 오른쪽 값 반환
- unless 연산자는 양쪽 표현식을 비교해 오른쪽 표현식의 출력 값에서 왼쪽 표현식에 나온 값들을 모두 제외하고 반환 

### 산술 연산자
- 사칙 연산(+, -, *, /), 나머지(%), 지수(^)와 같은 연산자로 메트릭의 값을 사용자가 원하는 값으로 반환

### 집계 연산자
- 평균(avg), 합계(sum), 계수(count)와 같이 수집된 메트릭을 종합하고 분석하는 연산자 (메트릭의 값을 좀 더 의미있는 데이터로 정리)


## PromQL 데이터 타입
- 프로메테우스 데이터베이스는 시계열 데이터베이스이고, 메트릭 데이터는 시계열 정보가 담겨 있다.
- PromQL 표현에 맞는 쿼리를 입력해도 시간 정보는 나타나지 않는데, 메트릭 데이터는 현재 시간을 내포하기 때문에 결과에 포함되지 않을 뿐이다.
- 시간을 포함한 메트릭 데이터를 확인하기 위해서는 [구간 값]을 입력해야 하는데, 프로메테우스는 레인지 셀렉터라고 한다.

### 종류
- 레인지 벡터 : 구간이 있는 PromQL 데이터 타입
- 인스턴스 벡터 : 특정 시점에 대한 메트릭 값만을 가지는 PromQL 데이터 타입
- 스칼라 타입 : 실수 값 표현 (주로 인스턴스 벡터 값을 변경하는 용도)
- 스트링 타입 : 문자열 표현 (프로메테우스 2.0부터 사용 X)

### 레인지 벡터 vs 인스턴스 벡터
#### 1) 웹 브라우저에 프로메테우스 웹 UI 2개 띄우기
- 하나는 node_cpu_seconds_total{mode="idle",kubernetes_node="w3-k8s"}
- 다른 하나는 node_cpu_seconds_total{mode="idle",kubernetes_node="w3-k8s"}[5m]

#### 2) w3-k8s 전원을 끄고 웹 UI 새로고침
- 2개의 UI에서 아무것도 검색되지 않는 것을 확인한다.

#### 3) w3-k8s 재시작 후 메트릭 데이터 받아오는지 확인
- @ 뒤에 표시되는 숫자는 유닉스 시간이다.

#### 4) 다시 웹 UI 리셋 후 메트릭 데이터 확인
- @ 뒤에 표시되는 숫자를 확인했을 때 3번에서 나온 값과 60초 차이이다.
- 이는 프로메테우스 기본 수집 주기가 60초이기 때문이다.

#### 5) 여섯 번째 매트릭 수집 시점 확인
- 첫 번째로 수집된 메트릭이 보이지 않게 된다.
- 이는 레인지 셀렉터를 5m으로 지정해 현 시점으로부터 4분 전(총 5분)까지의 메트릭만을 검색해 보여주기 때문이다.

## PromQL 함수
> 인스턴스 벡터로 추출한 메트릭을 그대로 사용하는 경우도 많지만, 구간의 의미를 알기 위해 함수의 도움을 받을 때도 있다.

|종류|용도|함수|
|---|------|------|
|연산 함수|수학 연산에 사용|abs(절댓값), ceil(올림), floor(내림), round(반올림), predict_linear(예측값) 등|
|변환 함수|데이터 타입 간 변환에 사용|scalar(스칼라로 변환), vector(벡터로 변환), rate(변화율), irate(순간 변화율) 등|
|집계 함수|수집된 레인지 벡터의 데이터 집계를 위해 사용|avg_over_time(평균), sum_over_time(합계), count_over_time(계수) 등|

### 변화율을 나타내는 rate
- rate(node_cpu_seconds_total{mode="idle",kubernetes_node="w3-k8s"}[5m])와 같이 쿼리 입력기에 입력한다. → 결과 값이 1보다 작게 나온다.


### 순간변화율을 나타내는 irate
- rate는 구간 시작 값과 구간 종료 값의 차이에 대한 변화율을 다루지만, irate는 구간 종료 바로 전 값과 구간 종료 값의 차이에 대한 변화율을 나타낸다.

### 추세를 보여주는 predict_linear
- 레인지 벡터로 수집된 과거 메트릭 데이터를 기반으로 앞으로 생성될 메트릭 값을 예측한다.

## 서머리와 히스토그램
> 서머리는 익스포터에서 이미 만들어진 값을 보여주고, 히스토그램은 요청을 받으면 이를 계산해서 보여준다.

### 서머리
- 이미 공개된 메트릭 값을 조회하면 바로 확인 가능하다.

### 히스토그램
- 쿼리 입력기에서 쿼리를 보내면 그때서야 내부 계산식을 통해 히스토그램 메트릭을 생성한다.




